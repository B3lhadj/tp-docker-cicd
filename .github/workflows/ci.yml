- name: Build Docker Images
  run: |
    docker build -t tp-backend ./backend
    docker build -t tp-frontend ./frontend
    # pas besoin de tp-db si MySQL est standard
    # docker build -t tp-db ./database

- name: Start services
  run: docker-compose up -d

- name: Wait for backend
  run: |
    echo "Attente du backend (max 60 s)..."
    for i in {1..30}; do
      if curl -f http://localhost:3000/api >/dev/null 2>&1; then
        echo "Backend est prêt !"
        break
      fi
      echo "En attente... ($i/30)"
      sleep 2
    done
    if [ $i -eq 30 ]; then
      echo "Timeout : backend non démarré"
      exit 1
    fi

- name: Test API Endpoint
  run: curl -f http://localhost:3000/api

- name: Test DB Endpoint
  run: curl -f http://localhost:3000/users

- name: Show logs on failure
  if: failure()
  run: docker-compose logs backend mysql
